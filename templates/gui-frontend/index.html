<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>alfa_fw_updater</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.3/css/bulma.min.css">
    <script type="text/javascript" src="/eel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-selection@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>    
    
    <script type="text/javascript">
      var settings;
      var current_box;
      var busy = false;
      var current_process = null;
      
      // manual mode variables
      var manual_hex_ready = false;
      var manual_connected = false;
      
      async function html_init() {
       
        set_current_box("welcome");
        load_settings();
        
        document.getElementById('header-info')
         .innerHTML = "version " + await eel.say_hello_py()();
        
        var el = document.getElementById('manual-device-id');
        for (var i = 1; i<=254; i++){
          var opt = document.createElement('option');
          opt.value = i;
          opt.innerHTML = i.toString() + " (0x" + i.toString(16) + ")";
          el.appendChild(opt);
        }
        
        manual_result();
      }
    
      function set_current_box(box) {
        var boxes = [
          'welcome',
          'manual',
          'machine'
        ];
        
        boxes.forEach(function(element) {
          document.getElementById('box-' + element).style.display = "none";
        });
        
        document.getElementById('box-' + box).style.display = "block";
      }
    
      async function load_settings() {
        settings = await eel.get_settings()();
        document.getElementById('setting-serial-port').value = settings.serial_port;
        document.getElementById('setting-strategy').value = settings.strategy;         
        
        if ("_default" in settings && settings["_default"])
          open_settings_box();
      }

      function save_settings() {
        console.log("save");
        settings.serial_port = document.getElementById('setting-serial-port').value;
        settings.strategy = document.getElementById('setting-strategy').value;
        eel.save_settings(settings);         
      }
      
      function open_settings_box() {
        document.getElementById('settings-box').classList.add('is-active');
      }
      
      function close_settings_box() {
        document.getElementById('settings-box').classList.remove('is-active');      
      }
      
      function set_busy(is_busy, process_name = null) {
        busy = is_busy;
               
        var buttons = Array.from(document.getElementsByClassName("button"));
        
        if (is_busy) {
          current_process = process_name;
          buttons.forEach(el => el.setAttribute("disabled", true));
        } else {
          current_process = null;
          buttons.forEach(el => el.removeAttribute("disabled"));
        }
      }
      
      function loadFile(dom_id, callback) {
        var inputField = document.getElementById(dom_id);
        var selectedFiles = inputField.files;
        for(var i=0; i<selectedFiles.length; i++) {
            var file = selectedFiles[i];
            var reader = new FileReader();
            reader.onload = function(loadedEvent) {
                // result contains loaded file.
                var file_content = loadedEvent.target.result;
                set_busy(true, "load_hex");                
                callback(file_content);
            }
            reader.readAsText(file);
            break; // consider only the 1st file
        }   
      } 
      
      function load_hex_file() {
        loadFile('manual-file-input', eel.process_hex)
      }

      function connect_disconnect() {
        var action = !manual_connected ? 'connect' : 'disconnect';
        set_busy(true, action);
        document.getElementById('manual-progress').style.display = "block";
        document.getElementById("manual-message-operation").style.display = "none";
        
        eel.process_manual({
          'action': action,
          'device_id': document.getElementById('manual-device-id').value
          });
      }

      function manual_operation(operation) {
        set_busy(true, operation);
        document.getElementById('manual-progress').style.display = "block";
        document.getElementById("manual-message-operation").style.display = "none";
        
        eel.process_manual({
          'action': operation,
          });
      }

      eel.expose(update_process_js); // Expose this function to Python
      function update_process_js(process_sts) {
        console.log(process_sts);
        manual_result(process_sts);
      }
      
      function manual_result(process_sts = null) {
        if (current_process == "load_hex") {
          var text, cls;
          if (process_sts.result == "ok") {
            text = "File loaded correctly.";
            cls = "is-success";
          } else {
            text = "Failed to load file.<br> " + process_sts.output;
            cls = "is-danger";
          }        
          id = "manual-message-hex";
          var parent = document.querySelector("#" + id);        
          var child = document.querySelector("#" + id + " > .message-body");
          parent.style.display = "block";
          parent.classList.remove('is-success');
          parent.classList.remove('is-danger');
          parent.classList.add(cls);
          child.innerHTML = text;
          manual_hex_ready = true;

        } else if (current_process != null) {
          var text, title, cls;
          if (process_sts.result == "ok") {
            text = "Operation completed successfully<br>" +
                   (process_sts.output != "" ? "<pre>" + process_sts.output + "</pre>" : "");
            title = "Success"
            cls = "is-success";
          } else {
            title = "Failure";          
            text = process_sts.output;
            cls = "is-danger";
          }

          if (current_process == "jump" || current_process == "reset")
            connect_disconnect();
          
          id = "manual-message-operation";
          var parent = document.querySelector("#" + id);        
          var header = document.querySelector("#" + id + " > .message-header");
          var body = document.querySelector("#" + id + " > .message-body");
          parent.style.display = "block";
          parent.classList.remove('is-success');
          parent.classList.remove('is-danger');
          parent.classList.add(cls);
          body.innerHTML = text;
          header.innerHTML = title;
          
          if (current_process == "connect")
            manual_connected = (process_sts.result == "ok");
          else if (current_process == "disconnect") 
            manual_connected = (process_sts.result != "ok");
          
          document.getElementById('manual-progress').style.display = "none";
        }

        set_busy(false);
        
        var children = document.querySelectorAll("#manual-operation-buttons button");

        if (!manual_connected) {
          children.forEach(el => el.setAttribute("disabled", true));
          document.getElementById('manual-btn-connect').innerHTML = "Connect to device";
        } else {
          children.forEach(el => el.removeAttribute("disabled"))
          document.getElementById('manual-btn-connect').innerHTML = "Disconnect";          
        }

        if (!manual_hex_ready) {
            var children = document.querySelectorAll("#manual-operation-buttons .need-hex");
            children.forEach(el => el.setAttribute("disabled", true));
        }
        
      }
      
      
    </script>
  </head>
  <body onload="html_init()">
    <nav class="navbar" role="navigation" aria-label="main navigation">
      <div class="navbar-brand">
        <a class="navbar-item" href="https://bulma.io">
          <img src="https://bulma.io/images/bulma-logo.png" width="112" height="28">
        </a>

      </div>

      <div id="navbarBasicExample" class="navbar-menu">
        <div class="navbar-start">       
          <div class="navbar-item">
            <div class="buttons">
              <button class="button" onclick="set_current_box('welcome')">
                <strong>Welcome</strong>
              </button>
              <button class="button" onclick="set_current_box('manual')">
                <strong>Manual update</strong>
              </button>
              <button class="button" onclick="set_current_box('machine')">
                <strong>Machine update</strong>
              </button>
            </div>
          </div>
        </div>

        <div class="navbar-end">
          <div class="navbar-item">
            <div class="buttons">
              <button class="button is-primary" onclick="open_settings_box()">
                <strong>Settings</strong>
              </button>
            </div>
          </div>
          
          <div class="navbar-item" id="header-info">
            Initializing
          </div>
          
        </div>
      </div>
    </nav>  

    <div class="box" id="box-welcome">
      <div class="box">
        <p class="title">Welcome to alfa_fw_upgrader!</p>
        <p>This tool will guide you to upgrade one or more of our boards, or all of them.</p>
      </div>
      <div class="tile is-ancestor">
        <div class="tile is-parent is-vertical">
          <article class="tile is-child notification is-dark-grey">
            <p class="title">adjust settings</p>
            <p class="subtitle">set the parameters to connect to main board.</p>
            <p class="buttons"><button class="button">Go to settings</button></p>
          </article>
        </div>
        <div class="tile is-parent">
          <article class="tile is-child notification  is-dark-grey">
            <p class="title">manual update</p>
            <p class="subtitle">in this mode you can program a single board.</p>
            <p class="buttons"><button class="button">Go to page</button></p>
          </article>
        </div>
        <div class="tile is-parent">
          <article class="tile is-child notification   is-dark-grey">
            <div class="content">
              <p class="title">machine update</p>
              <p class="subtitle">in this mode you can update from a package.</p>
              <p class="buttons"><button class="button">Go to page</button></p>
            </div>
          </article>
        </div>
      </div>      
    </div>

    <div class="box" id="box-manual">
      <div class="field">
        <label class="label">Device address</label>
        <div class="control">
          <div class="select">
            <select id="manual-device-id">
              <option value="255">255 (0xFF) - master</option>
            </select>
          </div>
        </div>
      </div>
      <div class="field">
        <label class="label">Hex file</label>
        <div class="control">
          <input type="file" id="manual-file-input">
          <button class="button" id="manual-btn-load" onclick="load_hex_file();">Load</button>
        </div>
        <article class="message is-success" id="manual-message-hex" style="display:none;">
          <div class="message-body">
            Test
          </div>
        </article>
      </div>
      
      <div class="buttons" >
        <button class="button is-primary is-fullwidth is-light" id="manual-btn-connect" onclick="connect_disconnect();">Connect to device</button>
        <div class="tile is-ancestor box" id="manual-operation-buttons">
          <div class="tile">
            <button class="button is-fullwidth"  onclick="manual_operation('info');">Get info</button>
          </div>
          <div class="tile">
            <button class="button is-fullwidth need-hex"  onclick="manual_operation('program');">Program</button>        
          </div>
          <div class="tile">
            <button class="button is-fullwidth need-hex"  onclick="manual_operation('verify');">Verify</button>
          </div>
          <div class="tile">
            <button class="button is-fullwidth need-hex"  onclick="manual_operation('program_and_verify');">Program &amp; Verify</button>
          </div>
          <div class="tile">
            <button class="button is-fullwidth"  onclick="manual_operation('jump');">Jump to application</button>
          </div>
          <div class="tile">
            <button class="button is-fullwidth"  onclick="manual_operation('reset');">Reset boards</button>
          </div>
        </div>
      </div>
      <progress id="manual-progress" class="progress is-large is-primary" max="100" style="display:none;"></progress>      
      <article class="message is-success" id="manual-message-operation" style="display:none;">
        <div class="message-header">
          Operation result
        </div>
        <div class="message-body">
          Test
        </div>
      </article>
    </div>

    <div class="box" id="box-machine">
    
    </div>

    <div class="modal" id="settings-box">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Settings</p>
          <button class="delete" aria-label="close" onclick="close_settings_box()"></button>
        </header>
        <section class="modal-card-body">
          <div class="field">
            <label class="label">Serial port (e.g. /dev/ttyUSB0 on Linux, COM1 on Windows)</label>
            <div class="control">
              <input id="setting-serial-port" class="input" type="text" placeholder="Serial port">
            </div>
          </div>
          <div class="field">
            <label class="label">Connection Modality</label>
            <div class="control">
              <div class="select">
                <select id="setting-strategy">
                  <option value="simple">Simple (legacy mode)</option>
                  <option value="polling">Polling (first start connecting, then power on the board)</option>
                  <option value="serial">Serial (go to update mode when application is running)</option>
                </select>
              </div>
            </div>
          </div>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success" onclick="save_settings(); close_settings_box();">Save changes</button>
          <button class="button" onclick="close_settings_box();">Cancel</button>
        </footer>
      </div>
    </div>
  </body>
</html>
